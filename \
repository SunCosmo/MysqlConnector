#include <iostream>
#include <map>
#include <cstring>
#include <cstdlib>

#include "CResultSet.h"

void Bind(MYSQL_STMT *mysql_stmt, CResultSet *reset)
{
  reset->mysql_stmt_ = const_cast<MYSQL_STMT>(mysql_stmt);
  MYSQL_RES *metadata =
    mysql_stmt_result_metadata(mysql_stmt);
  int result_size = mysql_num_fields(metadata);
  reset->result_binds_ = 
    (MYSQL_BIND*)calloc(result_size, sizeof(MYSQL_BIND));
  reset->result_array_ = 
    (BYTE**)calloc(result_size_, sizeof(BYTE*));
  MYSQL_FIELD* fields = mysql_fetch_fields(metadata);
  for(int i=0; i<result_size_; ++i)
  {
    reset->result_binds_[i].buffer_type = fields[i].type;
    uint32_t buffer_length = fields[i].length;
    reset->result_binds_[i].buffer_length = buffer_length;
    reset->result_array_[i] = 
      (BYTE*)calloc(buffer_length, sizeof(BYTE));
    reset->result_binds_[i].buffer = reset->result_array_[i];
    reset->fields_map_.insert(
        std::make_pair(string(fields[i].name), i));
  }
  mysql_stmt_bind_result(mysql_stmt, reset->result_binds_);
  mysql_free_result(metadata_);
}

bool CResultSet::Check()
{



}

CResultSet::CResultSet(MYSQL_STMT *mysql_stmt):
    mysql_stmt_(mysql_stmt)
{

}

CResultSet::~CResultSet()
{
  if(result_array_)
  {
    for(int i=0; i<result_size_; ++i)
    {
      delete [] result_array_[i];
    }
    delete [] result_array_;
  }
  if(result_binds_)
  {
    delete [] result_binds_;
  }
}

bool CResultSet::Next()
{
  return (mysql_stmt_fetch(mysql_stmt_) == 0);
}

int CResultSet::GetInt(const string& name)
{
  int index = _GetIndex(name);
  if(index < 0) 
  {
    //log
    exit(0);
  }
  return *reinterpret_cast<int*>(result_array_[index]);
}

string CResultSet::GetString(const string& name)
{
  int index = _GetIndex(name);
  if(index < 0)
  {
    //log
    exit(0);
  }
  return string(reinterpret_cast<char *>(result_array_[index]));
}

int CResultSet::_GetIndex(const string& name)
{
  map<string, int>::iterator it = fields_map_.find(name);
  if(it == fields_map_.end()) return -1;
  else  return (int)it->second;
}

